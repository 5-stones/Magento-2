<!-- Add Gigya script to page body. Defined in view/frontend/layout/default.xml . Variables can be set and passed from the block object model: block/GigyaScript -->
<?php
// Alan storm : http://alanstorm.com/magento-2-frontend-files-serving
$api_key = $block->getGigyaApiKey();
$site = $block->getBaseUrl();
 //$login_action_url = $site . "gigya_raas/raas/gigyapost";
$login_action_url = $block->getPostActionUrl();
//$login_action_url = $block->getBaseUrl()."customer/account/gigyapost";
?>

<script>
    var success_url = "";   // will be added from gigya admin
    var error_url = "";     // will be added from gigya admin
    var dummy_password = "12qwaszx!@QWASZX"; // TODO: try to omit. (with line 66)

    function loadGigyaScript() {
        var gig = document.createElement('script');
        gig.type = 'text/javascript';
        gig.async = false;
        gig.src = ('https:' == document.location.protocol ? 'https://cdns' : 'http://cdn') + '.gigya.com/js/gigya.js?apiKey=<?php echo $api_key ?>';
        document.getElementsByTagName('head')[0].appendChild(gig);
    }
    loadGigyaScript();

    // utility functions:
    gigyaMage2 = {};
    gigyaMage2.Params = {};
    gigyaMage2.Functions = {};

    gigyaMage2.Functions.gigyaLoginEventHandler = function(eventObj) {
     //   var action = "<?php // echo $action_url; ?>";
        var action = "<?php  echo $login_action_url; ?>";

        var loginData = {
            UIDSignature : eventObj.UIDSignature,
            signatureTimestamp : eventObj.signatureTimestamp,
            UID : eventObj.UID
        };
        gigyaMage2.Functions.gigyaFormSubmit(action, loginData, eventObj );
    };

    gigyaMage2.Functions.gigyaFormSubmit = function (action, loginData, eventObj) {
        'use strict';
        var form;
        form = jQuery('<form />', {
            action: action,
            method: "POST",
            style: 'display: none;'
        });

        gigyaMage2.Functions.createInputField("login_data", JSON.stringify(loginData), form);
        // form key is added in login page
        if ( jQuery('input[name="form_key"]').val().length ){
            var form_key = jQuery('input[name="form_key"]').val();
            gigyaMage2.Functions.createInputField("form_key", form_key, form);
        }
        // For Magento registration requests TODO: try to omit.
        gigyaMage2.Functions.createInputField("success_url", success_url, form);
        gigyaMage2.Functions.createInputField("error_url", error_url, form);
        gigyaMage2.Functions.createInputField("firstname", eventObj.profile.firstname, form);
        gigyaMage2.Functions.createInputField("lastname", eventObj.profile.lastname, form);
        gigyaMage2.Functions.createInputField("password", dummy_password, form);
        gigyaMage2.Functions.createInputField("password_confirmation", dummy_password, form);

        gigyaMage2.Functions.createInputField("lastname", eventObj.profile.email, form);

        // for Magento login requests  TODO: try to omit.
        gigyaMage2.Functions.createInputField("login[username]", eventObj.profile.email, form);
        gigyaMage2.Functions.createInputField("login[password]", dummy_password, form);
        //
        form.appendTo('body');
        form.submit();
    };

    gigyaMage2.Functions.createInputField = function (name, value, form) {
        jQuery('<input>').attr({
            type: 'hidden',
            name: name,
            value: value
        }).appendTo(form);
    };

    gigyaMage2.Functions.gigyaLogoutListener = function() {
        jQuery('a[href$="logout/"]').click(function () {
            gigya.accounts.logout();
            return true;
        });
    };

    gigyaMage2.Functions.gigyaUpdateProfile = function(eventObj) {
        var action = "<?php /* @escapeNotVerified */ echo $block->getUrl('customer/account/editPost') ?>";

        var loginData = {
            // decide if: get these from response and get user data to update from server
//            UIDSignature : eventObj.UIDSignature,
//            signatureTimestamp : eventObj.signatureTimestamp,
//            UID : eventObj.UID
            email : eventObj.profile.email,
            firstName : eventObj.profile.firstName,
            lastName : eventObj.profile.lastName,
            gender : eventObj.profile.gender
        };

        gigyaMage2.Functions.gigyaFormSubmit(action, loginData, eventObj );
    };

    // init registered Gigya functions
    function onGigyaServiceReady(serviceName) {
        if (window.gigyaInit) {
            // push callback to edit profile (needs to be more robust)
            if( window.gigyaInit[0].parameters.containerID == "gigya-edit-profile") {
                window.gigyaInit[0].parameters.onAfterSubmit = gigyaMage2.Functions.gigyaUpdateProfile;
            }
            var length = window.gigyaInit.length,
                element = null;
            if (length > 0) {
                for (var i = 0; i < length; i++) {
                    element = window.gigyaInit[i];
                    func = element.function;
                    var parts = func.split("\.");
                    var f = gigya[parts[0]][parts[1]];
                    if (typeof f === "function") {
                        f(element.parameters);
                    }
                }
            }

            gigya.accounts.addEventHandlers(
                {
                    onLogin: gigyaMage2.Functions.gigyaLoginEventHandler,
                    onAfterSubmit : gigyaMage2.Functions.gigyaUpdateProfile
                }
            )
        }
    }
    gigyaMage2.Functions.gigyaLogoutListener();
</script>
<?php
/*
// Gigya Post minimal:
// $_POST = {array} [11]
    // eventName = "login"
    // remember = "false"
    // provider = "facebook"
    // loginMode = "standard"
    // newUser = "false"
    // UIDSignature = "o/Esfdi+0Y5Q16h8JyZ4NJH9P9g="
    // signatureTimestamp = "1450341234"
    // UID = "_guid_PpabVRL9jSl1I1fp151zFHFSc08FOWLKH6IJ3WQqcMw="
    // profile = {array} [7]
        //  firstName = "Guy"
        //  lastName = "Gigi"
        //  photoURL = "https://graph.facebook.com/v2.3/100008758338831/picture?type=large"
        //  thumbnailURL = "https://graph.facebook.com/v2.3/100008758338831/picture?type=square"
        //  profileURL = "https://www.facebook.com/app_scoped_user_id/100008758338831/"
        //  gender = "m"
        //  email = "gigguy191@gmail.com"
    // isGlobal = "true"
    // source = "showScreenSet"
*/
?>